<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Photomatic</title>

    <style>
      body {
        margin: 0;
        background: #000;
        height: 100vh;
        overflow: hidden;
      }

      /* Background layers for crossfade */
      .background {
        position: absolute;
        top: 0;
        left: 0;
        width: 100vw;
        height: 100vh;
        background-size: cover;
        background-position: center;
        background-repeat: no-repeat;
        filter: blur(15px);
        opacity: 0;
        transition: opacity 2s ease-in-out;
        z-index: -1;
      }

      .background.show {
        opacity: 0.5;
      }

      /* Slideshow image */
      img {
        max-width: 100vw;
        max-height: 100vh;
        min-width: 50vw;
        min-height: 50vh;
        object-fit: contain;
        transition: opacity 2s ease-in-out, transform 2s ease-in-out;
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        z-index: 1;
        filter: drop-shadow(0 10px 30px rgba(0, 0, 0, 0.6));
        border-radius: 12px;
        opacity: 0;
      }

      /* Foreground transitions */
      .fade.show {
        opacity: 1;
      }

      .zoom {
        transform: translate(-50%, -50%) scale(0.8);
      }

      .zoom.show {
        transform: translate(-50%, -50%) scale(1);
        opacity: 1;
      }

      .slide-left {
        transform: translate(-150%, -50%);
      }

      .slide-left.show {
        transform: translate(-50%, -50%);
        opacity: 1;
      }

      .slide-right {
        transform: translate(50%, -50%);
      }

      .slide-right.show {
        transform: translate(-50%, -50%);
        opacity: 1;
      }

      .slide-up {
        transform: translate(-50%, -150%);
      }

      .slide-up.show {
        transform: translate(-50%, -50%);
        opacity: 1;
      }

      .slide-down {
        transform: translate(-50%, 50%);
      }

      .slide-down.show {
        transform: translate(-50%, -50%);
        opacity: 1;
      }

      .rotate {
        transform: translate(-50%, -50%) rotate(-180deg) scale(0.5);
      }

      .rotate.show {
        transform: translate(-50%, -50%) rotate(0deg) scale(1);
        opacity: 1;
      }

      /* Date/time overlay */
      #datetime {
        position: absolute;
        bottom: 40px;
        right: 50px;
        text-align: right;
        color: white;
        font-family: 'Segoe UI', Arial, sans-serif;
        z-index: 3;
      }

      /* WEATHER BLOCK */
      #weather {
        display: flex;
        flex-direction: row;
        align-items: center;
        justify-content: flex-end;
        gap: 8px;
        margin-bottom: -20px;
        position: relative;
        z-index: 4;
      }

      /* Weather icon as DIV */
      #weather-icon {
        width: 60px;
        height: 60px;
        background-size: contain;
        background-repeat: no-repeat;
        background-position: center;
        display: inline-block;
        filter: drop-shadow(0 0 6px rgba(0, 0, 0, 0.7));
        z-index: 5;
        filter: brightness(0) invert(1);
      }

      #weather-temp {
        font-size: 4em;
        font-weight: bold;
        text-shadow: -1px -1px 0 #000, 1px -1px 0 #000, -1px 1px 0 #000,
          1px 1px 0 #000, 0 0 8px rgba(255, 255, 255, 0.6);
        -webkit-text-stroke: 1px black;
      }

      #time {
        font-size: 4.5em;
        font-weight: bold;
        text-shadow: -1px -1px 0 #000, 1px -1px 0 #000, -1px 1px 0 #000,
          1px 1px 0 #000, 0 0 10px rgba(255, 255, 255, 0.6);
        -webkit-text-stroke: 1px black;
      }

      #date {
        font-size: 2.5em;
        text-shadow: -1px -1px 0 #000, 1px -1px 0 #000, -1px 1px 0 #000,
          1px 1px 0 #000, 0 0 6px rgba(255, 255, 255, 0.5);
        -webkit-text-stroke: 1px black;
      }
    </style>
  </head>

  <body>
    <div id="background1" class="background"></div>
    <div id="background2" class="background"></div>

    <img id="slideshow" src="" alt="slideshow" />

    <div id="datetime">
      <div id="weather">
        <div id="weather-icon"></div>
        <div id="weather-temp"></div>
      </div>
      <div id="time"></div>
      <div id="date"></div>
    </div>

    <script>
      const transitions = [
        'fade',
        'zoom',
        'slide-left',
        'slide-right',
        'slide-up',
        'slide-down',
        'rotate',
      ];

      const iconStyles = {
        meteocons: 'https://api.iconify.design/meteocons/',
        solar: 'https://api.iconify.design/solar/',
        phosphor: 'https://api.iconify.design/ph/',
        material: 'https://api.iconify.design/material-symbols/',
        linemd: 'https://api.iconify.design/line-md/',
        wi: 'https://api.iconify.design/wi/',
        carbon: 'https://api.iconify.design/carbon/',
        lucide: 'https://api.iconify.design/lucide/',
      };

      const iconNames = {
        meteocons: {
          'clear-day': 'clear-day',
          'partly-cloudy-day': 'partly-cloudy-day',
          cloudy: 'cloudy',
          overcast: 'overcast',
          fog: 'fog',
          drizzle: 'drizzle',
          rain: 'rain',
          snow: 'snow',
          thunderstorms: 'thunderstorms',
        },

        solar: {
          'clear-day': 'sun-bold',
          'partly-cloudy-day': 'cloud-sun-bold',
          cloudy: 'cloud-bold',
          overcast: 'clouds-bold',
          fog: 'fog-bold',
          drizzle: 'cloud-drizzle-bold',
          rain: 'cloud-rain-bold',
          snow: 'cloud-snow-bold',
          thunderstorms: 'cloud-lightning-bold',
        },

        phosphor: {
          'clear-day': 'sun-bold',
          'partly-cloudy-day': 'cloud-sun-bold',
          cloudy: 'cloud-bold',
          overcast: 'clouds-bold',
          fog: 'cloud-fog-bold',
          drizzle: 'cloud-drizzle-bold',
          rain: 'cloud-rain-bold',
          snow: 'cloud-snow-bold',
          thunderstorms: 'cloud-lightning-bold',
        },

        material: {
          'clear-day': 'sunny',
          'partly-cloudy-day': 'partly-cloudy-day',
          cloudy: 'cloud',
          overcast: 'cloud',
          fog: 'foggy',
          drizzle: 'rainy',
          rain: 'rainy',
          snow: 'weather-snowy',
          thunderstorms: 'thunderstorm',
        },

        linemd: {
          'clear-day': 'sunny',
          'partly-cloudy-day': 'cloudy-sunny',
          cloudy: 'cloud',
          overcast: 'cloud',
          fog: 'cloud-alt',
          drizzle: 'cloud-drizzle',
          rain: 'cloud-rain',
          snow: 'cloud-snow',
          thunderstorms: 'cloud-lightning',
        },

        wi: {
          'clear-day': 'day-sunny',
          'partly-cloudy-day': 'day-cloudy',
          cloudy: 'cloud',
          overcast: 'cloudy',
          fog: 'fog',
          drizzle: 'sprinkle',
          rain: 'rain',
          snow: 'snow',
          thunderstorms: 'thunderstorm',
        },

        carbon: {
          'clear-day': 'sun',
          'partly-cloudy-day': 'partly-cloudy',
          cloudy: 'cloud',
          overcast: 'cloud',
          fog: 'fog',
          drizzle: 'rain-drizzle',
          rain: 'rain',
          snow: 'snow',
          thunderstorms: 'thunderstorm',
        },

        lucide: {
          'clear-day': 'sun',
          'partly-cloudy-day': 'cloud-sun',
          cloudy: 'cloud',
          overcast: 'cloud',
          fog: 'cloud-fog',
          drizzle: 'cloud-drizzle',
          rain: 'cloud-rain',
          snow: 'snowflake',
          thunderstorms: 'cloud-lightning',
        },
      };

      const weatherMap = {
        0: 'clear-day',
        1: 'partly-cloudy-day',
        2: 'cloudy',
        3: 'overcast',
        45: 'fog',
        48: 'fog',
        51: 'drizzle',
        53: 'drizzle',
        55: 'drizzle',
        61: 'rain',
        63: 'rain',
        65: 'rain',
        71: 'snow',
        73: 'snow',
        75: 'snow',
        80: 'rain',
        81: 'rain',
        82: 'rain',
        95: 'thunderstorms',
        96: 'thunderstorms',
        99: 'thunderstorms',
      };

      let currentBg = 1;
      let currentStyle = 'lucide'; // change to any pack

      async function loadImage() {
        try {
          const img = document.getElementById('slideshow');
          const randomTransition =
            transitions[Math.floor(Math.random() * transitions.length)];
          img.className = randomTransition;

          const res = await fetch('/random');
          if (!res.ok) return;

          const blob = await res.blob();
          const url = URL.createObjectURL(blob);

          const preload = new Image();
          preload.src = url;

          preload.onload = () => {
            const newBg = currentBg === 1 ? 2 : 1;
            const oldBg = currentBg === 1 ? 1 : 2;
            const bgNew = document.getElementById('background' + newBg);
            const bgOld = document.getElementById('background' + oldBg);

            bgNew.style.backgroundImage = `url(${url})`;
            bgNew.classList.add('show');
            bgOld.classList.remove('show');
            currentBg = newBg;

            const oldSrc = img.src;
            const newImg = new Image();
            newImg.src = url;

            newImg.onload = () => {
              img.classList.remove('show');
              setTimeout(() => {
                img.src = url;
                img.onload = () => {
                  img.classList.add('show');
                  if (oldSrc && oldSrc.startsWith('blob:')) {
                    URL.revokeObjectURL(oldSrc);
                  }
                };
              }, 500);
            };
          };
        } catch (err) {
          console.warn('Error loading image:', err);
        }
      }

      function updateDateTime() {
        const now = new Date();
        document.getElementById('time').textContent = now.toLocaleTimeString(
          [],
          { hour: '2-digit', minute: '2-digit', hour12: true }
        );
        document.getElementById('date').textContent = now.toLocaleDateString(
          [],
          { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' }
        );
      }

      async function getIconUrl(code) {
        const base = iconStyles[currentStyle];
        const generic = weatherMap[code] || 'cloudy';
        const icon = iconNames[currentStyle][generic];

        const response = await fetch('/cache_icon', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ url: `${base}${icon}.svg` }),
        });

        const data = await response.json();
        return `url(${data.path})`;
      }

      async function updateWeather() {
        try {
          // const lat = 53.342711;
          // const lon = -6.43189;

          const lat = 53.333;
          const lon = -6.249;

          const url = `https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}&current_weather=true`;

          const res = await fetch(url);
          const data = await res.json();

          const temp = Math.round(data.current_weather.temperature);
          const code = data.current_weather.weathercode;

          document.getElementById('weather-temp').textContent = temp + 'Â°c';
          document.getElementById('weather-icon').style.backgroundImage =
            await getIconUrl(code);
        } catch (err) {
          console.warn('Weather fetch failed:', err);
        }
      }

      loadImage();
      setInterval(loadImage, 30000);

      updateDateTime();
      setInterval(updateDateTime, 1000);

      updateWeather();
      setInterval(updateWeather, 10 * 60 * 1000);
    </script>
  </body>
</html>
