<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Photomatic</title>

    <style>
      body {
        margin: 0;
        background: #000;
        height: 100vh;
        overflow: hidden;
      }

      /* Background layers for crossfade */
      .background {
        position: absolute;
        top: 0;
        left: 0;
        width: 100vw;
        height: 100vh;
        background-size: cover;
        background-position: center;
        background-repeat: no-repeat;
        filter: blur(15px);
        opacity: 0;
        transition: opacity 2s ease-in-out;
        z-index: -1;
      }

      .background.show {
        opacity: 0.5;
      }

      /* Slideshow image */
      img {
        max-width: 100vw;
        max-height: 100vh;
        min-width: 50vw;
        min-height: 50vh;
        object-fit: contain;
        transition: opacity 2s ease-in-out, transform 2s ease-in-out;
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        z-index: 1;
        filter: drop-shadow(0 10px 30px rgba(0, 0, 0, 0.6));
        border-radius: 12px;
        opacity: 0;
      }

      /* Foreground transitions */
      .fade.show {
        opacity: 1;
      }

      .zoom {
        transform: translate(-50%, -50%) scale(0.8);
      }

      .zoom.show {
        transform: translate(-50%, -50%) scale(1);
        opacity: 1;
      }

      .slide-left {
        transform: translate(-150%, -50%);
      }
      .slide-left.show {
        transform: translate(-50%, -50%);
        opacity: 1;
      }

      .slide-right {
        transform: translate(50%, -50%);
      }
      .slide-right.show {
        transform: translate(-50%, -50%);
        opacity: 1;
      }

      .slide-up {
        transform: translate(-50%, -150%);
      }
      .slide-up.show {
        transform: translate(-50%, -50%);
        opacity: 1;
      }

      .slide-down {
        transform: translate(-50%, 50%);
      }
      .slide-down.show {
        transform: translate(-50%, -50%);
        opacity: 1;
      }

      .rotate {
        transform: translate(-50%, -50%) rotate(-180deg) scale(0.5);
      }
      .rotate.show {
        transform: translate(-50%, -50%) rotate(0deg) scale(1);
        opacity: 1;
      }

      /* Date/time overlay */
      #datetime {
        position: absolute;
        bottom: 40px;
        right: 50px;
        text-align: right;
        color: white;
        font-family: 'Segoe UI', Arial, sans-serif;
        z-index: 3;
      }

      /* WEATHER BLOCK */
      #weather {
        display: flex;
        flex-direction: row;
        align-items: center;
        justify-content: flex-end;
        gap: 8px;
        margin-bottom: -20px;
        position: relative;
        z-index: 4;
      }

      /* Weather icon as DIV */
      #weather-icon {
        width: 100px;
        height: 100px;
        background-size: contain;
        background-repeat: no-repeat;
        background-position: center;
        display: inline-block;
        filter: drop-shadow(0 0 6px rgba(0, 0, 0, 0.7));
        z-index: 5;
      }

      #weather-temp {
        font-size: 4em;
        font-weight: bold;
        text-shadow: -1px -1px 0 #000, 1px -1px 0 #000, -1px 1px 0 #000,
          1px 1px 0 #000, 0 0 8px rgba(255, 255, 255, 0.6);
        -webkit-text-stroke: 1px black;
      }

      #time {
        font-size: 4.5em;
        font-weight: bold;
        text-shadow: -1px -1px 0 #000, 1px -1px 0 #000, -1px 1px 0 #000,
          1px 1px 0 #000, 0 0 10px rgba(255, 255, 255, 0.6);
        -webkit-text-stroke: 1px black;
      }

      #date {
        font-size: 2.5em;
        text-shadow: -1px -1px 0 #000, 1px -1px 0 #000, -1px 1px 0 #000,
          1px 1px 0 #000, 0 0 6px rgba(255, 255, 255, 0.5);
        -webkit-text-stroke: 1px black;
      }
    </style>
  </head>

  <body>
    <div id="background1" class="background"></div>
    <div id="background2" class="background"></div>

    <img id="slideshow" src="" alt="slideshow" />

    <div id="datetime">
      <div id="weather">
        <div id="weather-icon"></div>
        <div id="weather-temp"></div>
      </div>
      <div id="time"></div>
      <div id="date"></div>
    </div>

    <script>
      const transitions = [
        'fade',
        'zoom',
        'slide-left',
        'slide-right',
        'slide-up',
        'slide-down',
        'rotate',
      ];
      let currentBg = 1;

      async function loadImage() {
        try {
          const img = document.getElementById('slideshow');
          const randomTransition =
            transitions[Math.floor(Math.random() * transitions.length)];
          img.className = randomTransition;

          const res = await fetch('/random');
          if (!res.ok) return;

          const blob = await res.blob();
          const url = URL.createObjectURL(blob);

          const preload = new Image();
          preload.src = url;

          preload.onload = () => {
            const newBg = currentBg === 1 ? 2 : 1;
            const oldBg = currentBg === 1 ? 1 : 2;
            const bgNew = document.getElementById('background' + newBg);
            const bgOld = document.getElementById('background' + oldBg);

            bgNew.style.backgroundImage = `url(${url})`;
            bgNew.classList.add('show');
            bgOld.classList.remove('show');
            currentBg = newBg;

            const oldSrc = img.src;
            const newImg = new Image();
            newImg.src = url;

            newImg.onload = () => {
              img.classList.remove('show');
              setTimeout(() => {
                img.src = url;
                img.onload = () => {
                  img.classList.add('show');
                  if (oldSrc && oldSrc.startsWith('blob:')) {
                    URL.revokeObjectURL(oldSrc);
                  }
                };
              }, 500);
            };
          };
        } catch (err) {
          console.warn('Error loading image:', err);
        }
      }

      loadImage();
      setInterval(loadImage, 30000);

      function updateDateTime() {
        const now = new Date();
        document.getElementById('time').textContent = now.toLocaleTimeString(
          [],
          { hour: '2-digit', minute: '2-digit', hour12: true }
        );
        document.getElementById('date').textContent = now.toLocaleDateString(
          [],
          { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' }
        );
      }

      updateDateTime();
      setInterval(updateDateTime, 1000);

      async function updateWeather() {
        try {
          const lat = 53.357;
          const lon = -6.448;

          const url = `https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}&current_weather=true`;

          const res = await fetch(url);
          const data = await res.json();

          const temp = Math.round(data.current_weather.temperature);
          const code = data.current_weather.weathercode;

          document.getElementById('weather-temp').textContent = temp + 'Â°C';

          const iconMap = {
            0: 'https://openweathermap.org/img/wn/01d.png',
            1: 'https://openweathermap.org/img/wn/02d.png',
            2: 'https://openweathermap.org/img/wn/03d.png',
            3: 'https://openweathermap.org/img/wn/04d.png',
            45: 'https://openweathermap.org/img/wn/50d.png',
            48: 'https://openweathermap.org/img/wn/50d.png',
            51: 'https://openweathermap.org/img/wn/09d.png',
            53: 'https://openweathermap.org/img/wn/09d.png',
            55: 'https://openweathermap.org/img/wn/09d.png',
            61: 'https://openweathermap.org/img/wn/10d.png',
            63: 'https://openweathermap.org/img/wn/10d.png',
            65: 'https://openweathermap.org/img/wn/10d.png',
            71: 'https://openweathermap.org/img/wn/13d.png',
            73: 'https://openweathermap.org/img/wn/13d.png',
            75: 'https://openweathermap.org/img/wn/13d.png',
            95: 'https://openweathermap.org/img/wn/11d.png',
            96: 'https://openweathermap.org/img/wn/11d.png',
            99: 'https://openweathermap.org/img/wn/11d.png',
          };

          const iconUrl = iconMap[code] || iconMap[3];
          document.getElementById(
            'weather-icon'
          ).style.backgroundImage = `url(${iconUrl})`;
        } catch (err) {
          console.warn('Weather fetch failed:', err);
        }
      }

      updateWeather();
      setInterval(updateWeather, 10 * 60 * 1000);
    </script>
  </body>
</html>
